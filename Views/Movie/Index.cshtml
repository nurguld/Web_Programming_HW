
<!-- movie search with Ajax and Api endpoint -->
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Live Search (AJAX demo)</h5>
        <p class="card-text">
            This search uses an <strong>API endpoint</strong> and <strong>AJAX (fetch)</strong>, 
            without reloading the page.
        </p>

        <input type="text"
               id="liveSearchBox"
               class="form-control"
               placeholder="Type a movie title..." />

        <div id="liveSearchResults" class="mt-2">
            <!-- AJAX results will be inserted here -->
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const searchBox = document.getElementById("liveSearchBox");
        const resultsDiv = document.getElementById("liveSearchResults");

        searchBox.addEventListener("input", function () {
            const query = this.value.trim();

            if (query === "") {
                resultsDiv.innerHTML = "";
                return;
            }

            fetch(`/api/movies/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    resultsDiv.innerHTML = "";

                    if (!data || data.length === 0) {
                        resultsDiv.innerHTML = "<p>No movies found.</p>";
                        return;
                    }

                    let html = "<ul class='list-group'>";
                    data.forEach(m => {
                        html += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                                <strong>${m.title}</strong>
                                ${m.releaseYear ? "(" + m.releaseYear + ")" : ""}
                                ${m.genreName ? " - " + m.genreName : ""}
                            </span>
                            <a href="/Movie/Details/${m.id}" class="btn btn-sm btn-outline-primary">Details</a>
                        </li>`;
                    });
                    html += "</ul>";

                    resultsDiv.innerHTML = html;
                });
        });
    </script>
}

<!-- ------------------------------------------ -->




@model IEnumerable<CineClub.Models.Movie>
@{
    int currentPage = ViewData["CurrentPage"] != null ? (int)ViewData["CurrentPage"] : 1;
    int totalPages = ViewData["TotalPages"] != null ? (int)ViewData["TotalPages"] : 1;
}

<form asp-action="Index" method="get" class="mb-3 d-flex gap-2">

    <!-- movie search text box -->
    <input type="search"
           name="movieSearchString"
           value="@ViewData["MovieSearchString"]"
           class="form-control"
           placeholder="Search movie title or genre" />

    <!-- year selection -->
    <select name="year" class="form-select">
        <option value="">All Years</option>
        @if (ViewData["Years"] != null)
        {
            foreach (var y in ViewData["Years"] as List<int?>)
            {
                <option value="@y" selected="@((ViewData["Year"] as int?).HasValue && y == (ViewData["Year"] as int?).Value)">
                    @y
                </option>
            }
        }
    </select>

    <!-- genre selection -->
    <select name="genreId" class="form-select">
        <option value="">All Genres</option>
        @if (ViewData["Genres"] != null)
        {
            foreach (var g in ViewData["Genres"] as List<CineClub.Models.Genre>)
            {
                <option value="@g.Id" selected="@((ViewData["GenreId"] as int?).HasValue && g.Id == (ViewData["GenreId"] as int?).Value)">
                    @g.Name
                </option>
            }
        }
    </select>

    <button type="submit" class="btn btn-primary">Search</button>
    <a asp-action="Index" class="btn btn-outline-secondary">Clear</a>
</form>

@if (User.IsInRole("Admin"))
{
    <p>
        <a asp-action="Create">Create New</a>
    </p>
}

<table class="table">
    <thead>
        <tr>
            <th>
                @Html.DisplayNameFor(model => model.Title)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Description)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.ReleaseYear)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Genre)
            </th>
            <th></th>
        </tr>
    </thead>
    <tbody>
@foreach (var item in Model) {
        <tr>
            <td>
                @Html.DisplayFor(modelItem => item.Title)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Description)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.ReleaseYear)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Genre.Name)
            </td>
            @if (User.IsInRole("Admin"))
            {
                <td>
                    <a asp-action="Edit" asp-route-id="@item.Id">Edit</a> |
                    <a asp-action="Delete" asp-route-id="@item.Id">Delete</a>
                </td>
            }
            <td><a asp-action="Details" asp-route-id="@item.Id">Details</a></td>
        </tr>
}
    </tbody>
</table>


<!-- pagination -->
@if (totalPages > 1)
{
    <nav aria-label="Movie pagination">
        <ul class="pagination justify-content-center">

            <!-- previous page link -->
            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                <a class="page-link"
                   asp-action="Index"
                   asp-route-page="@(currentPage - 1)"
                   asp-route-year="@(ViewData["Year"])"
                   asp-route-genreId="@(ViewData["GenreId"])"
                   asp-route-movieSearchString="@(ViewData["MovieSearchString"])">
                    Previous
                </a>
            </li>

            <!-- page numbers -->
            @for (int i = 1; i <= totalPages; i++)
            {
                <li class="page-item @(i == currentPage ? "active" : "")">
                    <a class="page-link"
                       asp-action="Index"
                       asp-route-page="@i"
                       asp-route-year="@(ViewData["Year"])"
                       asp-route-genreId="@(ViewData["GenreId"])"
                       asp-route-movieSearchString="@(ViewData["MovieSearchString"])">
                        @i
                    </a>
                </li>
            }

            <!-- next page link -->
            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                <a class="page-link"
                   asp-action="Index"
                   asp-route-page="@(currentPage + 1)"
                   asp-route-year="@(ViewData["Year"])"
                   asp-route-genreId="@(ViewData["GenreId"])"
                   asp-route-movieSearchString="@(ViewData["MovieSearchString"])">
                    Next
                </a>
            </li>
        </ul>
    </nav>
}